<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Strike — 5文字ワード当て（ヒント付き）</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827">
<link rel="apple-touch-icon" href="icon-180.png">
<style>
  :root{
    --bg:#111827; --tile:#1f2937; --key:#374151; --text:#e5e7eb; --muted:#9ca3af;
    --hit:#10b981; --near:#f59e0b; --miss:#4b5563;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; background:var(--bg); color:var(--text);}
  .app{max-width:560px; margin:0 auto; padding:20px 16px;}
  h1{font-size:1.3rem; margin:0 0 8px; text-align:center}
  .muted{color:var(--muted); font-size:.95rem; text-align:center; margin-bottom:12px;}
  .board{display:grid; grid-template-rows:repeat(6,1fr); gap:8px; padding:8px 0; margin:10px 0 16px;}
  .row{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; height:56px;}
  .tile{display:flex; align-items:center; justify-content:center; border-radius:8px; background:var(--tile); font-weight:700; font-size:1.4rem; text-transform:uppercase;}
  .tile.reveal{animation:flip .5s ease;}
  @keyframes flip{0%{transform:rotateX(0)}50%{transform:rotateX(90deg)}100%{transform:rotateX(0)}}
  .hit{background:var(--hit)!important;color:#111}
  .near{background:var(--near)!important;color:#111}
  .miss{background:var(--miss)!important;color:#d1d5db}
  .keyboard{display:grid; gap:8px; user-select:none;}
  .kbrow{display:flex; gap:6px; justify-content:center;}
  .key{background:var(--key); color:#fff; border:0; border-radius:8px; padding:12px 10px; font-weight:600; cursor:pointer; min-width:32px;}
  .key.wide{min-width:64px;}
  .key.hit{background:var(--hit); color:#111}
  .key.near{background:var(--near); color:#111}
  .key.miss{background:var(--miss); color:#d1d5db}
  .panel{display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap;}
  .btn{background:#2563eb; color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;}
  .btn.ghost{background:#374151;}
  .msg{text-align:center; min-height:24px; margin:8px 0; font-weight:600;}
  .hintbox{margin-top:6px; text-align:center; color:#fef08a;}
</style>
</head>
<body>
<div class="app">
  <h1>Word Strike — 5文字ワード当て（ヒント付き）</h1>
  <div class="muted">6回以内に英単語を当てよう（A–Z 5文字／重複OK）</div>

  <div id="board" class="board"></div>
  <div id="msg" class="msg"></div>

  <div class="keyboard" id="keyboard"></div>

  <div class="panel">
    <button class="btn" id="giveup">ギブアップ</button>
    <button class="btn ghost" id="hintbtn">ヒント</button>
    <button class="btn ghost" id="newgame">新しいゲーム</button>
  </div>
  <div id="hintbox" class="hintbox"></div>
</div>

<script>
(() => {
  const WORDS = [
    "APPLE","BRAIN","CANDY","DELTA","EAGER","FAITH","GLASS","HONEY","IVORY","JELLY",
    "KNIFE","LEMON","MARCH","NOBLE","OCEAN","PEARL","QUICK","ROBOT","SAUCE","TIGER",
    "ULTRA","VIVID","WATER","XENON","YEAST","ZEBRA","ALPHA","BRAVE","CHEER","DREAM",
    "EARTH","FANCY","GIANT","HAPPY","IDEAL","JAZZY","KOALA","LIGHT","MANGO","NURSE",
    "OPERA","PIANO","QUEEN","RIVER","SMILE","TRACK","UNION","VOICE","WHEEL","YOUNG",
    "ZESTY","ANGEL","BLEND","CLOUD","DRIVE","ELITE","FLAME","GRAPE","HOUSE","INDEX",
    "JUMBO","KARMA","LASER","METAL","NINJA","OLIVE","PANDA","QUILT","RANGE","SHARE",
    "THEME","URBAN","VIRAL","WHALE","XRAYS","YUMMY","ZONED","ARBOR","BERRY","CHESS",
    "DODGE","EMBED","FROST","GHOST","HUMAN","INBOX","JOKER","KNEEL","LUNCH","MOTOR",
    "NORTH","OPINE","PRIZE","QUARK","ROCKY","SOLAR","TRUST","USAGE","VINYL","WRIST"
  ];
  const PROBE_WORDS = ["ARISE","SALET","CRANE","AUDIO","POINT","NOTES","LAYER","ROUND","SOARE","LEAST"];
  const rows = 6, cols = 5;
  const board = document.getElementById("board");
  const msg = document.getElementById("msg");
  const kb = document.getElementById("keyboard");
  const giveupBtn = document.getElementById("giveup");
  const newBtn = document.getElementById("newgame");
  const hintBtn = document.getElementById("hintbtn");
  const hintBox = document.getElementById("hintbox");

  let secret = "";
  let curRow = 0, curCol = 0;
  let grid = [];
  let finished = false;
  const keyStates = {}; // letter -> 'hit'|'near'|'miss'
  let hintCount = 0;     // 0→1→2→3

  function pickSecret() { return WORDS[Math.floor(Math.random()*WORDS.length)]; }

  function initBoard(){
    board.innerHTML = "";
    grid = [];
    for(let r=0;r<rows;r++){
      const row = document.createElement("div");
      row.className = "row";
      const arr = [];
      for(let c=0;c<cols;c++){
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.textContent = "";
        row.appendChild(tile);
        arr.push(tile);
      }
      board.appendChild(row);
      grid.push(arr);
    }
  }

  function initKeyboard(){
    kb.innerHTML = "";
    const layout = ["QWERTYUIOP","ASDFGHJKL","ZXCVBNM"];
    for(const line of layout){
      const row = document.createElement("div");
      row.className = "kbrow";
      if(line==="ZXCVBNM"){
        const enter = makeKey("ENTER","wide"); row.appendChild(enter);
      }
      for(const ch of line){
        row.appendChild(makeKey(ch));
      }
      if(line==="ZXCVBNM"){
        const back = makeKey("⌫","wide"); row.appendChild(back);
      }
      kb.appendChild(row);
    }
  }

  function makeKey(label, wide=false){
    const btn = document.createElement("button");
    btn.className = "key" + (wide?" wide":"");
    btn.textContent = label;
    btn.addEventListener("click", () => onKey(label));
    return btn;
  }

  function setKeyState(letter, state){
    const upper = letter.toUpperCase();
    if(!/[A-Z]/.test(upper)) return;
    const prev = keyStates[upper];
    const rank = {miss:0, near:1, hit:2};
    if(prev && rank[prev] >= rank[state]) return;
    keyStates[upper] = state;
    [...kb.querySelectorAll(".key")].forEach(b => {
      if(b.textContent===upper){
        b.classList.remove("hit","near","miss");
        b.classList.add(state);
      }
    });
  }

  function onKey(k){
    if(finished) return;
    if(k==="ENTER"){
      submit();
    } else if(k==="⌫"){
      if(curCol>0){
        curCol--;
        grid[curRow][curCol].textContent = "";
      }
    } else if(/^[A-Z]$/.test(k)){
      if(curCol<cols){
        grid[curRow][curCol].textContent = k;
        curCol++;
      }
    }
  }

  function handleKeydown(e){
    if(finished) return;
    const k = e.key;
    if(k==="Enter"){ submit(); }
    else if(k==="Backspace"){
      if(curCol>0){ curCol--; grid[curRow][curCol].textContent=""; }
    } else if(/^[a-zA-Z]$/.test(k)){
      if(curCol<cols){ grid[curRow][curCol].textContent = k.toUpperCase(); curCol++; }
    }
  }

  function scoreRow(guess, answer){
    const res = Array(cols).fill("miss");
    const a = answer.split("");
    const g = guess.split("");
    for(let i=0;i<cols;i++){
      if(g[i]===a[i]){ res[i]="hit"; a[i]=null; g[i]=null; }
    }
    for(let i=0;i<cols;i++){
      if(g[i] && a.includes(g[i])){
        res[i]="near";
        const idx = a.indexOf(g[i]);
        a[idx]=null;
      }
    }
    return res;
  }

  function submit(){
    if(curCol<cols){ showMsg("5文字入力してください"); return; }
    const guess = grid[curRow].map(t=>t.textContent).join("");
    if(!/^[A-Z]{5}$/.test(guess)){ showMsg("A–Zの5文字で入力"); return; }

    const res = scoreRow(guess, secret);
    res.forEach((st, i) => {
      const t = grid[curRow][i];
      setTimeout(() => {
        t.classList.add("reveal");
        t.classList.add(st);
        setKeyState(guess[i], st);
      }, i*120);
    });

    if(guess===secret){
      finished = true;
      setTimeout(()=>{ showMsg("🎉 正解！"); }, 650);
      return;
    }
    curRow++; curCol=0;
    if(curRow>=rows){
      finished = true;
      setTimeout(()=>{ showMsg(`答え：${secret}`); }, 200);
    } else {
      showMsg("");
    }
  }

  function showMsg(s){ msg.textContent = s; }

  function giveUp(){
    if(finished) return;
    finished = true;
    showMsg(`ギブアップ！答え：${secret}`);
  }

  function getGreenPattern(){
    const greens = Array(5).fill(null);
    for (let r = 0; r < curRow; r++) {
      for (let c = 0; c < 5; c++) {
        const t = grid[r][c];
        if (t.classList.contains('hit')) greens[c] = t.textContent;
      }
    }
    return greens;
  }
  function unusedLetters(){
    const out = [];
    for (let ch of "ABCDEFGHIJKLMNOPQRSTUVWXYZ") {
      if (keyStates[ch] !== 'miss') out.push(ch);
    }
    return out;
  }
  function makeHint(){
    if (finished) return "ゲームは終了しています。新しいゲームでお試しください。";
    hintCount = Math.min(hintCount + 1, 3);
    if (hintCount === 1) {
      const usable = new Set(unusedLetters());
      let best = null, bestScore = -1;
      for (const w of PROBE_WORDS) {
        const uniq = new Set(w);
        let s = 0; uniq.forEach(ch => { if (usable.has(ch)) s++; });
        if (s > bestScore) { bestScore = s; best = w; }
      }
      return `戦略ヒント：未確認の文字を多く試せます → 【${best}】`;
    }
    if (hintCount === 2) {
      const vowels = new Set(['A','E','I','O','U']);
      const vCount = [...secret].filter(ch => vowels.has(ch)).length;
      const hasDup = new Set(secret).size < 5;
      const common = ['E','A','R','I','O','T','N','S','L'];
      const notIn = common.filter(ch => keyStates[ch] === 'miss');
      return `特徴ヒント：母音は【${vCount}】個、同じ文字は【${hasDup ? "あり" : "なし"}】。` + (notIn.length ? ` また ${notIn.join('・')} は含まれません。` : "");
    }
    if (hintCount === 3) {
      const greens = getGreenPattern();
      const unknownIdx = [...Array(5).keys()].filter(i => !greens[i]);
      const idx = unknownIdx[Math.floor(Math.random() * unknownIdx.length)];
      return `確定ヒント：【${idx+1}】文字目は 【${secret[idx]}】`;
    }
    return "";
  }

  function newGame(){
    secret = pickSecret();
    curRow=0; curCol=0; finished=false; hintCount=0;
    Object.keys(keyStates).forEach(k=>delete keyStates[k]);
    initBoard(); initKeyboard(); showMsg(""); hintBox.textContent="";
  }

  initBoard(); initKeyboard(); newGame();
  document.addEventListener("keydown", handleKeydown);
  giveupBtn.addEventListener("click", giveUp);
  newBtn.addEventListener("click", newGame);
  hintBtn.addEventListener("click", ()=>{ hintBox.textContent = makeHint(); });

  // PWA registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(console.error);
    });
  }
})();
</script>
</body>
</html>
